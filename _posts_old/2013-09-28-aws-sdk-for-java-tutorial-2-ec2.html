---
layout: post
title: 'AWS SDK for Java - Tutorial 2 : EC2'
date: '2013-09-28T16:38:00.001+05:30'
author: Ketan Parmar
tags:
- spot instance
- aws sdk
- ondemand instance
- securitygroup
- aws java
- keypair
- pem
- ec2
- aws
modified_time: '2013-09-28T17:15:52.650+05:30'
thumbnail: http://4.bp.blogspot.com/-4x-lYAvXfMY/Uka11rAi0QI/AAAAAAAAEfY/7nNzCC97uT4/s72-c/Result+1.png
blogger_id: tag:blogger.com,1999:blog-17114597.post-5605476224279452430
blogger_orig_url: http://www.kpbird.com/2013/09/aws-sdk-for-java-tutorial-2-ec2.html
---

<div dir="ltr" style="line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: bold; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">Introduction</span></div><b id="docs-internal-guid-27e0c397-640b-2bda-bfc8-ac862f681e16" style="font-weight: normal;"><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"></span></b> <br /><div dir="ltr" style="line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;"><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/9Bk4oH2bTUksBs-Q-E1VSw6Nu4GLq5NNus3hDdIGtXxXdT0Khr2VLfhv7axtQRxDcCs=w300" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/9Bk4oH2bTUksBs-Q-E1VSw6Nu4GLq5NNus3hDdIGtXxXdT0Khr2VLfhv7axtQRxDcCs=w300" /></a></div><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">Amazon Elastic Compute Cloud (Amazon EC2) service provides resizable compute capacity in the cloud. It is designed to make web-scale computing easier for developers.</span></div><div dir="ltr" style="line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">Let’s create EC2 instance using Java SDK. &nbsp;</span></div><b style="font-weight: normal;"><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"></span></b> <br /><div dir="ltr" style="line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: bold; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">Prerequisite </span><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">&nbsp;</span></div><b style="font-weight: normal;"><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"></span></b> <br /><div dir="ltr" style="line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">1. EC2 Instance (OnDemand, Reserved and Spot Instance) </span></div><div dir="ltr" style="line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">2. KeyPair (Pem File)</span></div><div dir="ltr" style="line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">3. EC2 Security Group</span></div><div dir="ltr" style="line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">4. AWS AccessKey &amp; SecretKey</span></div><div dir="ltr" style="line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">5. EndPoint</span></div><div dir="ltr" style="line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">6. Region</span><br /><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"><br /></span></div><b style="font-weight: normal;"><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"></span></b> <br /><div dir="ltr" style="line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: bold; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">Step 1:</span><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"> Launch Eclipse</span></div><div dir="ltr" style="line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: bold; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">Step 2:</span><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"> File-&gt;New-&gt;Other-&gt;AWS</span></div><div dir="ltr" style="line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: bold; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">Step 3:</span><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"> Select “AWS Java Project”</span></div><b style="font-weight: normal;"><br /><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"></span><img height="506px;" src="https://lh3.googleusercontent.com/igW1NkfWQK_4MQELBEdn4J5-EXeM6Ap_qcgvTly-q54szwY7nspB2z6KWwfmeJSHBQPOsJ8P6D0po-EpkoI9MwYU9F_UF7Td0UFh-cwHjpJtB1KwQm5Y7BJC" width="536px;" /><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"></span></b><br /><div dir="ltr" style="line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: bold; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">Step 4:</span><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"> Create new class named “Main.java” with public static void main method.</span><br /><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"><br /></span></div><div dir="ltr" style="line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: bold; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">Step 5:</span><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"> Define few constances, that we will use to create security group, keypair and ec2 instance.</span><br /><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"><br /></span></div><b style="font-weight: normal;"><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"></span></b> <br /><pre class="brush:java"> private Logger log = Logger.getInstance(Main.class);<br /> <br /> // require variable for every operation <br /> private String accessKey = "YOUR ACCESS KEY";<br /> private String secretKey = "YOUR SECRET KEY" ;<br /> private AWSCredentials credentials;<br /> private String endPoint ;<br /> private Region region ;<br /> private AmazonEC2Client ec2client ;<br /> <br /> // EC2 Security Group  Variables<br /> private String groupName = "kpbirdec2securitygroup";<br /> private String groupDescription = "This is description";<br /> <br /> private String sshIpRange = "YOUR PUBLIC IP/32";<br /> private String sshprotocol = "tcp";<br /> private int sshFromPort = 22;<br /> private int sshToPort =22;<br /> <br /> private String httpIpRange = "0.0.0.0/0";<br /> private String httpProtocol = "tcp";<br /> private int httpFromPort = 80;<br /> private int httpToPort = 80;<br /> <br /> private String httpsIpRange = "0.0.0.0/0";<br /> private String httpsProtocol = "tcp";<br /> private int httpsFromPort = 443;<br /> private int httpsToProtocol = 443;<br /> <br /> // KeyPair variables<br /> private String keyName = "kpbirdkeypair";<br /> private String pemFilePath  = "PATH TO STORE PEM FILE"; //   /Users/kpbird/Desktop<br /> private String pemFileName = "kpbird_keypair.pem";<br /> <br /> <br /> // EC2 Instance variables<br /> private String imageId ="ami-64084736";<br /> private String instanceType ="t1.micro";<br /> private String instanceName = "kpbirdt1micro";<br /> <br /> // EC2 Spot Instance<br /> private String spotPrice = "0.080";<br /></pre><div dir="ltr" style="line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: bold; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">Step 6:</span><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"> initialize method create object of credentials, AmazonEC2Client and set endpoint and region for ec2client. </span><a href="http://docs.aws.amazon.com/general/latest/gr/rande.html" style="text-decoration: none;"><span style="background-color: transparent; color: #1155cc; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: underline; vertical-align: baseline; white-space: pre-wrap;">Click here</span></a><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"> to read more about EndPoint and Region.</span></div><pre class="brush:java">private void init(){<br /> credentials  = new BasicAWSCredentials(accessKey, secretKey);<br /> // end point for singapore <br /> endPoint = "https://rds.ap-southeast-1.amazonaws.com";<br /> // regions for singapore<br /> region = Region.getRegion(Regions.AP_SOUTHEAST_1);<br /> ec2client = new AmazonEC2Client(credentials);<br /> ec2client.setEndpoint(endPoint);<br /> ec2client.setRegion(region); <br />}<br /></pre><div dir="ltr" style="line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: bold; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">Step 7:</span><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"> Create Security Group includes three things 1. Security Group name and description 2. Permission (IP,Protocol and port range)and 3. Attach owner (AWS Account Owner) to security group.</span></div><b style="font-weight: normal;"><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"></span></b> <br /><pre class="brush:java"> private void createEC2SecurityGroup(){<br />  try {<br />   log.Info("Create Security Group Request");   <br />   CreateSecurityGroupRequest createSecurityGroupRequest =  new CreateSecurityGroupRequest();<br />   createSecurityGroupRequest.withGroupName(groupName)<br />   .withDescription(groupDescription);<br />   createSecurityGroupRequest.setRequestCredentials(credentials);<br />   CreateSecurityGroupResult csgr = ec2client.createSecurityGroup(createSecurityGroupRequest);<br />   <br />   String groupid = csgr.getGroupId();<br />   log.Info("Security Group Id : " + groupid);<br />   <br />   log.Info("Create Security Group Permission");<br />   Collection&lt;IpPermission&gt; ips = new ArrayList&lt;IpPermission&gt;();<br />   // Permission for SSH only to your ip<br />   IpPermission ipssh = new IpPermission();<br />   ipssh.withIpRanges(sshIpRange).withIpProtocol(sshprotocol)<br />   .withFromPort(sshFromPort).withToPort(sshToPort);<br />   ips.add(ipssh);<br />   <br />   // Permission for HTTP, any one can access<br />   IpPermission iphttp = new IpPermission();<br />   iphttp.withIpRanges(httpIpRange).withIpProtocol(httpProtocol)<br />   .withFromPort(httpFromPort).withToPort(httpToPort);<br />   ips.add(iphttp);<br />   <br />   //Permission for HTTPS, any one can accesss<br />   IpPermission iphttps = new IpPermission();<br />   iphttps.withIpRanges(httpsIpRange).withIpProtocol(httpsProtocol)<br />   .withFromPort(httpsFromPort).withToPort(httpsToProtocol);<br />   ips.add(iphttps);<br />   <br />   log.Info("Attach Owner to security group");<br />   // Register this security group with owner<br />   AuthorizeSecurityGroupIngressRequest authorizeSecurityGroupIngressRequest = new AuthorizeSecurityGroupIngressRequest();<br />   authorizeSecurityGroupIngressRequest<br />   .withGroupName(groupName).withIpPermissions(ips);<br />   ec2client.authorizeSecurityGroupIngress(authorizeSecurityGroupIngressRequest);<br />   <br />  } catch (Exception e) {<br />   e.printStackTrace();<br />   System.exit(0);<br />  }<br /> }</pre><div dir="ltr" style="line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: bold; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">Step 8: </span><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">Amazon EC2 uses public–key cryptography to encrypt and decrypt login information. Public–key cryptography uses a public key to encrypt a piece of data, such as a password, then the recipient uses the private key to decrypt the data. The public and private keys are known as a key pair.</span><br /><span style="color: black; font-family: 'Courier New'; font-size: 16px; line-height: 1.15; vertical-align: baseline; white-space: pre-wrap;"><br /></span><span style="color: black; font-family: 'Courier New'; font-size: 16px; line-height: 1.15; vertical-align: baseline; white-space: pre-wrap;">To log in to your instance, you must create a key pair, specify the name of the key pair when you launch the instance, and provide the private key when you connect to the instance. Linux/UNIX instances have no password, and you use a key pair to log in using SSH. </span><a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html" style="line-height: 1.15; text-decoration: none;"><span style="color: #1155cc; font-family: 'Courier New'; font-size: 16px; text-decoration: underline; vertical-align: baseline; white-space: pre-wrap;">Click here</span></a><span style="color: black; font-family: 'Courier New'; font-size: 16px; line-height: 1.15; vertical-align: baseline; white-space: pre-wrap;"> to read more about keypair.</span></div><br /><pre class="brush:java"> private void createKeyPair(){<br />  try {<br />   CreateKeyPairRequest ckpr = new CreateKeyPairRequest();<br />   ckpr.withKeyName(keyName);<br />   <br />   CreateKeyPairResult ckpresult = ec2client.createKeyPair(ckpr);<br />   KeyPair keypair = ckpresult.getKeyPair();<br />   String privateKey = keypair.getKeyMaterial();<br />   log.Info("KeyPair :" + privateKey);<br />   writePemFile(privateKey,pemFilePath,pemFileName); <br />  } catch (Exception e) {<br />   e.printStackTrace();<br />   System.exit(0);<br />  }<br /> }<br /></pre><br /><b style="font-weight: normal;"><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"></span></b> <br /><div dir="ltr" style="line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: bold; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">Step 9:</span><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"> EC2 instance require three things to create </span></div><div dir="ltr" style="line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">1. Image ID (AMI), AMI -Amazon Machine Image, AMI is image of operating system and few extra software configured with it. There can be two type of AMI a) public AMI which I am using in following code b) Private AMI, To read more about AMI </span><a href="http://aws.amazon.com/amazon-linux-ami/" style="text-decoration: none;"><span style="background-color: transparent; color: #1155cc; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: underline; vertical-align: baseline; white-space: pre-wrap;">click here</span></a><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"> </span></div><div dir="ltr" style="line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">2. Instance Type, Amazone provides different hardware configuration, you can choose as per your requirement, in this example I am using t1.micro which is smallest instance provided by Amazon AWS. To read more about Instance Type </span><a href="http://aws.amazon.com/ec2/instance-types/" style="text-decoration: none;"><span style="background-color: transparent; color: #1155cc; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: underline; vertical-align: baseline; white-space: pre-wrap;">click here</span></a><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"> </span></div><div dir="ltr" style="line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">3. Keypair name and security group name</span><br /><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"><br /></span></div><b style="font-weight: normal;"><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"></span></b><span style="font-family: 'Courier New'; font-size: 16px; line-height: 18px; white-space: pre-wrap;"><b>Step 9a Create OnDemand Instance</b></span><br /><pre class="brush:java"> private void createEC2OnDemandInstance(){<br />  try {<br />   <br />   // request for new on demand instance<br />   RunInstancesRequest rir = new RunInstancesRequest();<br />   rir.withImageId(imageId);<br />   rir.withInstanceType(instanceType);<br />   rir.withMinCount(1);<br />   rir.withMaxCount(1);<br />   rir.withKeyName(keyName);<br />   rir.withMonitoring(true);<br />   rir.withSecurityGroups(groupName);<br />   <br />   RunInstancesResult riresult = ec2client.runInstances(rir);<br />   log.Info(riresult.getReservation().getReservationId());<br />   <br />   /// Find newly created instance id<br />   String instanceId=null;<br />   DescribeInstancesResult result = ec2client.describeInstances();<br />   Iterator&lt;Reservation&gt; i = result.getReservations().iterator();<br />   while (i.hasNext()) {<br />    Reservation r = i.next();<br />    List&lt;Instance&gt; instances = r.getInstances();<br />    for (Instance ii : instances) {<br />     log.Info(ii.getImageId() + "t" + ii.getInstanceId()+ "t" + ii.getState().getName() + "t"+ ii.getPrivateDnsName());<br />     if (ii.getState().getName().equals("pending")) {<br />      instanceId = ii.getInstanceId();<br />     }<br />    }<br />   }<br />   <br />   log.Info("New Instance ID :" + instanceId);<br />   /// Waiting for Instance Running////<br />   boolean isWaiting = true;<br />   while (isWaiting) {<br />    log.Info("*** Waiting ***");<br />    Thread.sleep(1000);<br />    DescribeInstancesResult r = ec2client.describeInstances();<br />    Iterator&lt;Reservation&gt; ir= r.getReservations().iterator();<br />    while(ir.hasNext()){<br />     Reservation rr = ir.next();<br />     List&lt;Instance&gt; instances = rr.getInstances();<br />     for(Instance ii : instances){<br />      log.Info(ii.getImageId() + "t" + ii.getInstanceId()+ "t" + ii.getState().getName() + "t"+ ii.getPrivateDnsName());<br />      if (ii.getState().getName().equals("running") &amp;&amp; ii.getInstanceId().equals(instanceId) ) {<br />       log.Info(ii.getPublicDnsName());<br />       isWaiting=false;<br />      }<br />     }<br />    }<br />   }<br />   <br />   /// Creating Tag for New Instance ////<br />   log.Info("Creating Tags for New Instance");<br />   CreateTagsRequest crt = new CreateTagsRequest();<br />   ArrayList&lt;Tag&gt; arrTag = new ArrayList&lt;Tag&gt;();<br />   arrTag.add(new Tag().withKey("Name").withValue(instanceName));<br />   crt.setTags(arrTag);<br />   <br />   ArrayList&lt;String&gt; arrInstances = new ArrayList&lt;String&gt;();<br />   arrInstances.add(instanceId);<br />   crt.setResources(arrInstances);<br />   ec2client.createTags(crt);<br />   <br />   <br />  } catch (Exception e) {<br />   e.printStackTrace();<br />   System.exit(0);<br />  }<br /> }<br /><br /></pre><span style="font-family: 'Courier New'; font-size: 16px; line-height: 1.15; white-space: pre-wrap;"><b>Step 9b Create Spot Instance </b></span><br /><div dir="ltr" style="line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: 'Courier New'; font-size: 16px; vertical-align: baseline; white-space: pre-wrap;"><span style="font-family: Times; font-size: small; line-height: normal; white-space: normal;"> </span></span><br /><pre class="brush:java"> private void createEC2SpotInstance(){<br />  try {<br />   /// Creating Spot Instance ////<br />   <br />   // Initializes a Spot Instance Request<br />   RequestSpotInstancesRequest requestRequest = new RequestSpotInstancesRequest();<br />   // Request 1 x t1.micro instance with a bid price of $0.03.<br />   requestRequest.setSpotPrice(spotPrice);<br />   requestRequest.setInstanceCount(Integer.valueOf(1));<br />   LaunchSpecification launchSpecification = new LaunchSpecification();<br />   launchSpecification.setImageId(imageId);<br />   launchSpecification.setInstanceType(instanceType);<br />   launchSpecification.setMonitoringEnabled(true);<br />   <br />   // Add the security group to the request.<br />   ArrayList&lt;String&gt; securityGroups = new ArrayList&lt;String&gt;();<br />   securityGroups.add(groupName);<br />   launchSpecification.setSecurityGroups(securityGroups);<br />   <br />   launchSpecification.setKeyName(keyName);<br /><br />   // Add the launch specifications to the request.<br />   requestRequest.setLaunchSpecification(launchSpecification);<br /><br />   // Call the RequestSpotInstance API.<br />   RequestSpotInstancesResult requestResult = ec2client.requestSpotInstances(requestRequest);<br />   <br />   List&lt;SpotInstanceRequest&gt; requestResponses = requestResult.getSpotInstanceRequests();<br /><br />   // Setup an arraylist to collect all of the request ids we want to<br />   // watch hit the running state.<br />   ArrayList&lt;String&gt; spotInstanceRequestIds = new ArrayList&lt;String&gt;();<br /><br />   // Add all of the request ids to the hashset, so we can determine when they hit the<br />   // active state.<br />   for (SpotInstanceRequest requestResponse : requestResponses) {<br />       System.out.println("Created Spot Request: "+requestResponse.getSpotInstanceRequestId());<br />       spotInstanceRequestIds.add(requestResponse.getSpotInstanceRequestId());<br />       log.Info(requestResponse.getInstanceId() + "t" + requestResponse.getState());<br />   }<br />   <br />   String instanceId=null;<br />   boolean isWaiting=true;<br />   while(isWaiting){<br />    log.Info("*** Waiting for Spot Instance Request ***");<br />    Thread.sleep(5000);<br />     DescribeSpotInstanceRequestsRequest describeRequest = new DescribeSpotInstanceRequestsRequest();<br />     describeRequest.setSpotInstanceRequestIds(spotInstanceRequestIds);<br />     <br />     DescribeSpotInstanceRequestsResult describeResult = ec2client.describeSpotInstanceRequests(describeRequest);<br />        List&lt;SpotInstanceRequest&gt; describeResponses = describeResult.getSpotInstanceRequests();<br />        for (SpotInstanceRequest describeResponse : describeResponses) {<br />         log.Info(describeResponse.getInstanceId() + "t" + describeResponse.getState() + "t" + describeResponse.getSpotInstanceRequestId() + "t" + describeResponse.getStatus().getCode() + "t" + describeResponse.getStatus().getMessage());<br />           if (describeResponse.getState().equals("active")) {<br />               isWaiting = false;<br />               instanceId = describeResponse.getInstanceId();<br />               break;<br />           }<br />        }<br />    <br />   }<br />   isWaiting = true;<br />   while (isWaiting) {<br />    log.Info("*** Waiting for Instance Running ***");<br />    Thread.sleep(1000);<br />    DescribeInstancesResult r = ec2client.describeInstances();<br />    Iterator&lt;Reservation&gt; ir= r.getReservations().iterator();<br />    while(ir.hasNext()){<br />     Reservation rr = ir.next();<br />     List&lt;Instance&gt; instances = rr.getInstances();<br />     for(Instance ii : instances){<br />      log.Info(ii.getImageId() + "t" + ii.getInstanceId()+ "t" + ii.getState().getName() + "t"+ ii.getPrivateDnsName());<br />      if (ii.getState().getName().equals("running") &amp;&amp; ii.getInstanceId().equals(instanceId) ) {<br />       log.Info(ii.getPublicDnsName());<br />       String publicDNS = ii.getPublicDnsName();<br />       log.Info("Public DNS :" + publicDNS);<br />       isWaiting=false;<br />      }<br />     }<br />    }<br />   }<br />   <br />   /// Creating Tag for New Instance ////<br />   log.Info("Creating Tags for New Instance");<br />   CreateTagsRequest crt = new CreateTagsRequest();<br />   ArrayList&lt;Tag&gt; arrTag = new ArrayList&lt;Tag&gt;();<br />   arrTag.add(new Tag().withKey("Name").withValue(instanceName));<br />   crt.setTags(arrTag);<br />   <br />   ArrayList&lt;String&gt; arrInstances = new ArrayList&lt;String&gt;();<br />   arrInstances.add(instanceId);<br />   crt.setResources(arrInstances);<br />   ec2client.createTags(crt);<br />   <br />   <br />  } catch (Exception e) {<br />   e.printStackTrace();<br />  }<br /> }</pre></div><span style="font-family: Courier New, Courier, monospace;"><br /></span><span style="font-family: Courier New, Courier, monospace;"><b>Amazon AWS Management Console Screen Shots</b></span><br /><div class="separator" style="clear: both; text-align: center;"></div><br /><div class="separator" style="clear: both; text-align: center;"></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://4.bp.blogspot.com/-4x-lYAvXfMY/Uka11rAi0QI/AAAAAAAAEfY/7nNzCC97uT4/s1600/Result+1.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="260" src="http://4.bp.blogspot.com/-4x-lYAvXfMY/Uka11rAi0QI/AAAAAAAAEfY/7nNzCC97uT4/s640/Result+1.png" width="640" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">EC2 Instance</td></tr></tbody></table><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://4.bp.blogspot.com/-Vm4LppKbbqo/Uka11ebpHDI/AAAAAAAAEfQ/DqCjF3wGQN0/s1600/Result+2.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="252" src="http://4.bp.blogspot.com/-Vm4LppKbbqo/Uka11ebpHDI/AAAAAAAAEfQ/DqCjF3wGQN0/s640/Result+2.png" width="640" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">EC2 Security Group</td></tr></tbody></table><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://4.bp.blogspot.com/-8XgEdomc5vw/Uka11VJRWsI/AAAAAAAAEfU/Ju8OwBroIUk/s1600/Result+3.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="236" src="http://4.bp.blogspot.com/-8XgEdomc5vw/Uka11VJRWsI/AAAAAAAAEfU/Ju8OwBroIUk/s640/Result+3.png" width="640" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">KeyPair</td></tr></tbody></table><div dir="ltr" style="line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: large; font-style: normal; font-variant: normal; font-weight: bold; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"><a href="https://github.com/kpbird/AWS-EC2-Java-Tutorial">Download Source Code</a></span></div><span style="font-family: 'Courier New'; font-size: 16px; font-weight: bold; line-height: 1.15; white-space: pre-wrap;"><br /></span><span style="font-family: 'Courier New'; font-size: 16px; font-weight: bold; line-height: 1.15; white-space: pre-wrap;">References</span><br /><b style="font-weight: normal;"><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"></span></b> <br /><div dir="ltr" style="line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">1. </span><a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EC2_GetStarted.html" style="text-decoration: none;"><span style="background-color: transparent; color: #1155cc; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: underline; vertical-align: baseline; white-space: pre-wrap;">http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EC2_GetStarted.html</span></a><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"></span></div><div dir="ltr" style="line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">2. </span><a href="https://help.ubuntu.com/community/EC2StartersGuide" style="text-decoration: none;"><span style="background-color: transparent; color: #1155cc; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: underline; vertical-align: baseline; white-space: pre-wrap;">https://help.ubuntu.com/community/EC2StartersGuide</span></a><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"></span></div><div dir="ltr" style="line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">3. </span><a href="http://www.youtube.com/watch?v=ZAB8wCg9MyE" style="text-decoration: none;"><span style="background-color: transparent; color: #1155cc; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: underline; vertical-align: baseline; white-space: pre-wrap;">http://www.youtube.com/watch?v=ZAB8wCg9MyE</span></a><span style="background-color: transparent; color: black; font-family: 'Courier New'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"></span></div><br /><span style="font-family: 'Courier New'; font-size: 16px; vertical-align: baseline; white-space: pre-wrap;"></span>