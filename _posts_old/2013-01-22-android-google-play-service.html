---
layout: post
title: 'Android Google Play Service : Authorization'
date: '2013-01-22T13:21:00.000+05:30'
author: Ketan Parmar
tags:
- service
- google play
- authorization
- google
- google play service
- Andorid
modified_time: '2013-01-28T18:24:07.892+05:30'
thumbnail: http://2.bp.blogspot.com/-BLjJ1azg03I/UP0Z7TyJALI/AAAAAAAADoQ/A5vfwKsTy9A/s72-c/device-2013-01-18-145819.png
blogger_id: tag:blogger.com,1999:blog-17114597.post-8658674501645302933
blogger_orig_url: http://www.kpbird.com/2013/01/android-google-play-service.html
---

<span style="font-family: Verdana, sans-serif;">Google Play Service, the most&nbsp;promising release for me.&nbsp;I wish google play service will get accepted as a regular practice by developers&nbsp;and&nbsp;users in app for authentication.&nbsp;</span><br /><span style="font-family: Verdana, sans-serif;"><br /></span><span style="font-family: Verdana, sans-serif;">Google Play Service has three major APIs</span><br /><ol><li><span style="font-family: Verdana, sans-serif;"><a href="http://developer.android.com/google/play-services/auth.html" target="_blank">Authorization</a>&nbsp;</span></li><li><span style="font-family: Verdana, sans-serif;"><a href="http://developer.android.com/google/play-services/plus.html" target="_blank">Google+</a></span></li><li><span style="font-family: Verdana, sans-serif;"><a href="http://developer.android.com/google/play-services/maps.html" target="_blank">Google Maps</a></span></li></ol><span style="font-family: Verdana, sans-serif;">This tutorial contains explanation&nbsp;of Authorization API. It's standard way to authorize your user, It leverage existing Google Play Accounts.&nbsp;</span><br /><div><span style="font-family: Verdana, sans-serif;"><br /></span></div><div><span style="font-family: Verdana, sans-serif;">This demo app has four buttons&nbsp;</span><br /><div><ol><li><span style="font-family: Verdana, sans-serif;"><b>isGooglePlayServiceAvailable()</b> - To check availability of google play service.</span></li><li><span style="font-family: Verdana, sans-serif;"><b>Get Account Name</b> - To allow user to select gmail account (popup will display only if user has configured multiple gmail accounts)</span></li><li><span style="font-family: Verdana, sans-serif;"><b>getToken()</b> - To fetch authorization token.</span></li><li><span style="font-family: Verdana, sans-serif;"><b>invalidateToken()</b> - To invalidate token.</span></li></ol><span style="font-family: Verdana, sans-serif;">Read following link to know "How Google Play Service works?"</span><br /><span style="font-family: Verdana, sans-serif;"><a href="http://developer.android.com/google/play-services/index.html%C2%A0%C2%A0" target="_blank">http://developer.android.com/google/play-services/index.html&nbsp;&nbsp;</a></span><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-BLjJ1azg03I/UP0Z7TyJALI/AAAAAAAADoQ/A5vfwKsTy9A/s1600/device-2013-01-18-145819.png" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" height="320" src="http://2.bp.blogspot.com/-BLjJ1azg03I/UP0Z7TyJALI/AAAAAAAADoQ/A5vfwKsTy9A/s320/device-2013-01-18-145819.png" width="180" /></a></div>&nbsp;<a href="http://4.bp.blogspot.com/-d0TUL01QCVM/UP0Z7ggGAvI/AAAAAAAADoU/UYTOslwvXf0/s1600/device-2013-01-18-150447.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em; text-align: center;"><img border="0" height="320" src="http://4.bp.blogspot.com/-d0TUL01QCVM/UP0Z7ggGAvI/AAAAAAAADoU/UYTOslwvXf0/s320/device-2013-01-18-150447.png" width="180" /></a><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-XIhQFiwIbwc/UP0Z8kpT8kI/AAAAAAAADog/-d1cbcNfS7E/s1600/device-2013-01-18-150457.png" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" height="320" src="http://1.bp.blogspot.com/-XIhQFiwIbwc/UP0Z8kpT8kI/AAAAAAAADog/-d1cbcNfS7E/s320/device-2013-01-18-150457.png" width="180" /></a></div>&nbsp;<a href="http://1.bp.blogspot.com/-UMpqwhwXXiM/UP0Z8axiyeI/AAAAAAAADoY/SpZOTo0SvrE/s1600/device-2013-01-18-151920.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em; text-align: center;"><img border="0" height="320" src="http://1.bp.blogspot.com/-UMpqwhwXXiM/UP0Z8axiyeI/AAAAAAAADoY/SpZOTo0SvrE/s320/device-2013-01-18-151920.png" width="180" /></a><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-Z1WBmUEEsTI/UP0Z9Lo05vI/AAAAAAAADos/ULk2ti2f2pw/s1600/device-2013-01-18-151932.png" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" height="320" src="http://2.bp.blogspot.com/-Z1WBmUEEsTI/UP0Z9Lo05vI/AAAAAAAADos/ULk2ti2f2pw/s320/device-2013-01-18-151932.png" width="180" /></a></div>&nbsp;<a href="http://4.bp.blogspot.com/-RuPgnds8FRE/UP0Z7VwqQrI/AAAAAAAADoM/y5HSCkNAvVI/s1600/device-2013-01-18-145624.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em; text-align: center;"><img border="0" height="320" src="http://4.bp.blogspot.com/-RuPgnds8FRE/UP0Z7VwqQrI/AAAAAAAADoM/y5HSCkNAvVI/s320/device-2013-01-18-145624.png" width="180" /></a><br /><br /><a name='more'></a><b style="font-family: Verdana, sans-serif;">Flow of Google Play Service : Authorization API</b><br /><b style="font-family: Verdana, sans-serif;"><br /></b><a href="http://3.bp.blogspot.com/-4uiOoJNZdeE/UP0ekD33RAI/AAAAAAAADpE/D6VLf88f6gY/s1600/Google+Play+Service.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em; text-align: center;"><img border="0" height="640" src="http://3.bp.blogspot.com/-4uiOoJNZdeE/UP0ekD33RAI/AAAAAAAADpE/D6VLf88f6gY/s640/Google+Play+Service.jpg" width="536" /></a><br /><br /><span style="font-family: Verdana, sans-serif;">Above flow chart&nbsp;illustrates&nbsp;google play service authorization process, It has four major steps.</span><br /><ol><li><span style="font-family: Verdana, sans-serif;">Check Google Play Service available</span></li><li><span style="font-family: Verdana, sans-serif;">Select Gmail Account</span></li><li><span style="font-family: Verdana, sans-serif;">Ask for Permission</span></li><li><span style="font-family: Verdana, sans-serif;">Get Token</span></li></ol><span style="font-family: Verdana, sans-serif;">When you call GoogleAuthUtil.getToken(), for the first time, it throws <b>UserRecoverableAuthException</b> with one intent, you need to start activity with that intent to ask permission from user.</span><br /><i><br /></i><i>"<a href="http://developer.android.com/reference/com/google/android/gms/auth/UserRecoverableAuthException.html" style="background-color: #f9f9f9; color: #258aaf; font-family: Roboto, sans-serif; font-size: 14px; line-height: 19px; text-decoration: initial;"><code style="color: inherit; font-family: 'courier new', courier, monospace; font-weight: bold; line-height: 1.5;">UserRecoverableAuthException</code></a><span style="background-color: #f9f9f9; color: #222222; font-family: Roboto, sans-serif; font-size: 14px; line-height: 19px;">: This exception is thrown when an error occurs that users can resolve, such as not yet granting access to their accounts or if they changed their password. This exception class contains a&nbsp;</span><code style="background-color: #f9f9f9; color: #006600; font-family: 'courier new', courier, monospace; font-size: 14px; font-weight: bold; line-height: 1.5;"><a href="http://developer.android.com/reference/android/app/Activity.html#getIntent()" style="color: #258aaf; text-decoration: initial;">getIntent()</a></code><span style="background-color: #f9f9f9; color: #222222; font-family: Roboto, sans-serif; font-size: 14px; line-height: 19px;">&nbsp;method that you can call to obtain an intent that you can use with</span><code style="background-color: #f9f9f9; color: #006600; font-family: 'courier new', courier, monospace; font-size: 14px; font-weight: bold; line-height: 1.5;"><a href="http://developer.android.com/reference/android/app/Activity.html#startActivityForResult(android.content.Intent, int)" style="color: #258aaf; text-decoration: initial;">startActivityForResult()</a></code><span style="background-color: #f9f9f9; color: #222222; font-family: Roboto, sans-serif; font-size: 14px; line-height: 19px;">&nbsp;to obtain the user's resolution. You will need to handle the</span><code style="background-color: #f9f9f9; color: #006600; font-family: 'courier new', courier, monospace; font-size: 14px; font-weight: bold; line-height: 1.5;"><a href="http://developer.android.com/reference/android/app/Activity.html#onActivityResult(int, int, android.content.Intent)" style="color: #258aaf; text-decoration: initial;">onActivityResult()</a></code><span style="background-color: #f9f9f9; color: #222222; font-family: Roboto, sans-serif; font-size: 14px; line-height: 19px;">&nbsp;callback when this activity returns to take action based on the user's actions.</span>"</i><br /><br /><u><span style="font-family: Verdana, sans-serif;">I can't&nbsp;figure out&nbsp;reason why Google Play Service throws exception for first time to ask permission,</span></u><span style="font-family: Verdana, sans-serif;"><u>There should be methods to check permission and grant permission</u></span><br /><br /><b style="font-family: Verdana, sans-serif; text-align: center;">Step 1 : Download Google Play Service&nbsp;</b><span style="font-family: Verdana, sans-serif; text-align: center;">&nbsp;</span><br /><span style="font-family: Verdana, sans-serif;"><br /></span><span style="font-family: Verdana, sans-serif;">Google Play Service is not a part of Android SDK so you need to download library using Android SDK Manager. Read this like for more information <a href="http://developer.android.com/google/play-services/setup.html">http://developer.android.com/google/play-services/setup.html</a></span><br /><span style="font-family: Verdana, sans-serif;"><br /></span><span style="font-family: Verdana, sans-serif;"><b>Step 2 : Import Google Play Service library project </b>from &lt;Android SDK&gt;/extras/google/google_play_services copy/libproject/google-play-services_lib</span><br /><span style="font-family: Verdana, sans-serif;"><br /></span><span style="font-family: Verdana, sans-serif;"><b>Step 3: Create Android project named "GooglePlayService"</b> (Don't confuse with name It's project name)</span><br /><span style="font-family: Verdana, sans-serif;"><br /></span><span style="font-family: Verdana, sans-serif;"><b>Step 4 : Add Reference of Google Play Service Library in our project</b></span><br /><span style="font-family: Verdana, sans-serif;">Right click on project name -&gt; select properties -&gt; select Android -&gt; Click on Add button -&gt; select google play service libproject</span><br /><span style="font-family: Verdana, sans-serif;"><br /></span><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-6ZBxxAL4vRI/UP07Ry5OXgI/AAAAAAAADpU/B-rAvh4lcak/s1600/Screen+Shot+2013-01-21+at+5.08.20+PM.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="320" src="http://2.bp.blogspot.com/-6ZBxxAL4vRI/UP07Ry5OXgI/AAAAAAAADpU/B-rAvh4lcak/s320/Screen+Shot+2013-01-21+at+5.08.20+PM.png" width="209" /></a></div><br /><span style="font-family: Verdana, sans-serif;"><b>Step 5 : make gui as display in screen shots, open activity_main.xml from layout</b></span><br /><span style="font-family: Verdana, sans-serif;">below layout has four buttons (namely&nbsp;</span><span style="font-family: Verdana, sans-serif;">btnCheckService, btnAccountName, btGetToken, btnInvalidate</span><span style="font-family: Verdana, sans-serif;">) for different actions and two textview to display gmail account and token.</span><br /><br /><pre class="brush:xml">&lt;RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"<br />    xmlns:tools="http://schemas.android.com/tools"<br />    android:layout_width="match_parent"<br />    android:layout_height="match_parent"<br />    tools:context=".MainActivity" &gt;<br /><br />    &lt;Button<br />        android:id="@+id/btnCheckService"<br />        android:layout_width="wrap_content"<br />        android:layout_height="wrap_content"<br />        android:layout_alignParentLeft="true"<br />        android:layout_alignParentRight="true"<br />        android:layout_alignParentTop="true"<br />        android:onClick="buttonClicked"<br />        android:text=" isGooglePlayServicesAvailable()" /&gt;<br /><br />    &lt;Button<br />        android:id="@+id/btnAccountNames"<br />        android:layout_width="wrap_content"<br />        android:layout_height="wrap_content"<br />        android:layout_alignParentLeft="true"<br />        android:layout_alignParentRight="true"<br />        android:layout_below="@+id/btnCheckService"<br />        android:onClick="buttonClicked"<br />        android:text="Get Account Names" /&gt;<br /><br />    &lt;TextView<br />        android:id="@+id/txtAccount"<br />        android:layout_width="wrap_content"<br />        android:layout_height="wrap_content"<br />        android:layout_alignParentLeft="true"<br />        android:layout_alignParentRight="true"<br />        android:layout_below="@+id/btnAccountNames"<br />        android:text="Selected Account"<br />        android:textAppearance="?android:attr/textAppearanceLarge" /&gt;<br /><br />    &lt;Button<br />        android:id="@+id/btnGetToken"<br />        android:layout_width="wrap_content"<br />        android:layout_height="wrap_content"<br />        android:layout_alignParentLeft="true"<br />        android:layout_alignParentRight="true"<br />        android:layout_below="@+id/txtAccount"<br />        android:onClick="buttonClicked"<br />        android:text="getToken" /&gt;<br /><br />    &lt;TextView<br />        android:id="@+id/txtToken"<br />        android:layout_width="wrap_content"<br />        android:layout_height="wrap_content"<br />        android:layout_alignParentLeft="true"<br />        android:layout_alignParentRight="true"<br />        android:layout_below="@+id/btnGetToken"<br />        android:text="Token"<br />        android:textAppearance="?android:attr/textAppearanceLarge" /&gt;<br /><br />    &lt;Button<br />        android:id="@+id/btnInvalidate"<br />        android:layout_width="wrap_content"<br />        android:layout_height="wrap_content"<br />        android:layout_alignParentLeft="true"<br />        android:layout_alignParentRight="true"<br />        android:layout_below="@+id/txtToken"<br />        android:onClick="buttonClicked"<br />        android:text="Invalidate Token" /&gt;<br /><br />&lt;/RelativeLayout&gt;<br /></pre><br /><b style="font-family: Verdana, sans-serif;">Step 6 : Edit MainActivity.java</b><br /><pre class="brush:java">package com.kpbird.googleplayservice;<br /><br />import android.accounts.AccountManager;<br />import android.app.Activity;<br />import android.content.Intent;<br />import android.os.AsyncTask;<br />import android.os.Bundle;<br />import android.util.Log;<br />import android.view.View;<br />import android.widget.TextView;<br />import android.widget.Toast;<br /><br />import com.google.android.gms.auth.GoogleAuthUtil;<br />import com.google.android.gms.auth.UserRecoverableAuthException;<br />import com.google.android.gms.common.AccountPicker;<br />import com.google.android.gms.common.ConnectionResult;<br />import com.google.android.gms.common.GooglePlayServicesUtil;<br /><br />public class MainActivity extends Activity {<br /><br /> private TextView txtAccount;<br /> private TextView txtToken;<br /> private static final int USER_RECOVERABLE_AUTH = 5;<br /> private static final int ACCOUNT_PICKER = 2;<br /><br /> @Override<br /> protected void onCreate(Bundle savedInstanceState) {<br />  super.onCreate(savedInstanceState);<br />  setContentView(R.layout.activity_main);<br />  txtAccount = (TextView) findViewById(R.id.txtAccount);<br />  txtToken = (TextView) findViewById(R.id.txtToken);<br /> }<br /><br /> public void buttonClicked(View v) {<br />  if (v.getId() == R.id.btnCheckService) {<br />   checkStatus();<br />  } else if (v.getId() == R.id.btnAccountNames) {<br />   getAccountNames();<br />  } else if (v.getId() == R.id.btnGetToken) {<br />   new GetAuthToken(this, txtAccount.getText().toString()).execute();<br />  } else if(v.getId() == R.id.btnInvalidate){<br />   GoogleAuthUtil.invalidateToken(this, txtToken.getText().toString());<br />  }<br />  <br /> }<br /><br /> public void checkStatus() {<br />  int status = GooglePlayServicesUtil.isGooglePlayServicesAvailable(this);<br />  switch (status) {<br />  case ConnectionResult.SUCCESS:<br />   Toast.makeText(this, "Success", Toast.LENGTH_SHORT).show();<br />   break;<br />  case ConnectionResult.SERVICE_MISSING:<br />   Toast.makeText(this, "Service Missing", Toast.LENGTH_SHORT).show();<br />   break;<br />  case ConnectionResult.SERVICE_VERSION_UPDATE_REQUIRED:<br />   Toast.makeText(this, "Service Version Update Required",<br />     Toast.LENGTH_SHORT).show();<br />   break;<br />  case ConnectionResult.SERVICE_DISABLED:<br />   Toast.makeText(this, "Service Disabled", Toast.LENGTH_SHORT).show();<br />   break;<br />  }<br /> }<br /><br /> private void getAccountNames() {<br />  Intent intent = AccountPicker.newChooseAccountIntent(null, null,<br />    new String[] { "com.google" }, false, null, null, null, null);<br />  startActivityForResult(intent, ACCOUNT_PICKER);<br /> }<br /><br /> @Override<br /> protected void onActivityResult(int requestCode, int resultCode, Intent data) {<br />  if (requestCode == ACCOUNT_PICKER &amp;&amp; resultCode == RESULT_OK) {<br />   String accountName = data.getStringExtra(AccountManager.KEY_ACCOUNT_NAME);<br />   txtAccount.setText(accountName);<br />   <br />  } else if (requestCode == USER_RECOVERABLE_AUTH &amp;&amp; resultCode == RESULT_OK) {<br />   new GetAuthToken(this, txtAccount.getText().toString()).execute();<br />  } else if (requestCode == USER_RECOVERABLE_AUTH &amp;&amp; resultCode == RESULT_CANCELED) {<br />   Toast.makeText(this, "User rejected authorization.",<br />     Toast.LENGTH_SHORT).show();<br />  }<br /> }<br /><br /> class GetAuthToken extends AsyncTask<void string="" void=""> {<br /><br />  private MainActivity mActivity;<br />  private String mEmail;<br /><br />  public GetAuthToken(MainActivity mActivity, String mEmail) {<br />   this.mActivity = mActivity;<br />   this.mEmail = mEmail;<br />  }<br /><br />  @Override<br />  protected void onPreExecute() {<br />  }<br /><br />  @Override<br />  protected String doInBackground(Void... params) {<br />   try {<br />    Log.i("MainActivity", mEmail);<br />    String token = GoogleAuthUtil.getToken(mActivity, mEmail,"oauth2:https://www.googleapis.com/auth/userinfo.profile");<br />    Log.i("MainActivity", token);<br />    return token;<br /><br />   } catch (UserRecoverableAuthException userRecoverableException) {<br />    mActivity.startActivityForResult(userRecoverableException.getIntent(),USER_RECOVERABLE_AUTH);<br />   } catch (Exception e) {<br />    e.printStackTrace();<br />   }<br />   return null;<br />  }<br /><br />  @Override<br />  protected void onPostExecute(String result) {<br />   if (result != null)<br />    txtToken.setText(result);<br />  }<br /><br /> }<br />}<br /><br /></void></pre>Above code contain following important methods<br /><br /><ul><li><b>buttonClicked :</b> listener for all buttons.</li><li><b>checkStatus :</b>&nbsp;It is use to check play service status, simple method contain only one call "        <div class="p1">GooglePlayServicesUtil.isGooglePlayServicesAvailable(<span class="s1">this</span>);"</div></li><li><b>getAccountName </b>: It is use to pick account, There are two ways by which you can select an account 1. <b>android.accounts.Account</b> class 2. <b>AccountPicker</b> class. AccountPicker is an easy and clean method to pick an account. It displays picker dialog if use has multiple gmail accounts, whereupon it provides response in onActivityResult.</li><li><b>GetAuthToken (AsyncTask) :</b>&nbsp;It use to fetch auth token in doInBackground method using<br />GoogleAuthUtil.getToken(), When you run first time it will throw&nbsp;UserRecoverableAuthException exception with one intent. We need to startActivityForResult with the intent and we will get response in onActivityResult. We can take further action based on user's response. call getToken() second time if user accepts/allow application.</li></ul><a href="https://docs.google.com/file/d/0B9CK0aNgCtjRRFlseHR2ck1oXzg/edit" target="_blank"><span style="font-size: large;">Download Source : Click</span></a></div></div><div>[To download zip file Click File menu -&gt;Download]</div><div><br /><span style="font-size: large;"><a href="https://github.com/kpbird/google-play-service" target="_blank">Source from GitHub</a></span></div><div><br /></div>