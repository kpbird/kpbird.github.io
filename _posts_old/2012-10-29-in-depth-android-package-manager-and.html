---
layout: post
title: 'In Depth : Android Package Manager and Package Installer '
date: '2012-10-29T23:45:00.001+05:30'
author: Ketan Parmar
tags:
- Package Manager
- Android framework
- Android
- Package Installer
- Package Manager Service
- Package
modified_time: '2013-01-18T16:31:53.455+05:30'
thumbnail: http://4.bp.blogspot.com/-Z2m5BI4bY8A/UI620rmsneI/AAAAAAAADfo/1AGZGc21uNY/s72-c/Package+Installer.jpg
blogger_id: tag:blogger.com,1999:blog-17114597.post-2833776599926772492
blogger_orig_url: http://www.kpbird.com/2012/10/in-depth-android-package-manager-and.html
---

<div dir="ltr" style="text-align: left;" trbidi="on">We are installing and uninstalling APK(s) every day, might be many time in a day, but have you try to get answer of following questions ?<br /><div class="p2"><br /></div><div class="p1">1. What is Package Manager and Package Installer ?</div><div class="p1">2. Where APK files stores in Android ?</div><div class="p1">3. What is APK installation process in detail ?</div><div class="p1">4. How Package Manager store data ?</div><div class="p1">5. Where I can find source code of Package Manager and Package Installer ?<br /><br /><br /><a name='more'></a><div class="p1"><b><strong>1. What is Package Manager and Package Installer ?</strong></b></div><div class="p2"><br /></div><div class="p3" style="text-align: justify;"><b>PackageInstaller</b> is the default application for Android to install interactively normal package. PackateInstaller provide user interface to manage applications/package. PackageInstaller calls InstallAppProgress activity to receives an instruction from the user. InstallAppProgress will ask Package Manager Service to install package via indalld. Source code is available at&nbsp; &lt;Android Source&gt;/packages/apps/PackageInstaller.</div><div class="p2"><br /></div><div class="p3" style="text-align: justify;"><br /><div class="p1">Installd&nbsp; daemon's primary role is to receive request from Package Manager Service via Linux domain socket / dev/ socket/ installed. installd execute series of steps to install APK with root permission<br />[Ref:&nbsp;<a href="https://github.com/android/platform_frameworks_base/blob/master/cmds/installd/commands.c">https://github.com/android/platform_frameworks_base/blob/master/cmds/installd/commands.c</a>]</div><div class="p1"></div><br /><b><br /></b><b><strong>Package Manage</strong></b> is API which actually manage application install, uninstall, upgrade.When we install APK file, Package Manager parse the package(APK) file and display confirmation, When user press OK button, Package Manager call method named "installPackage" with these four parameters namely uri, installFlags, observer, installPackageName. Package Manager start one service named "package", now all fuzzy things happen in this service. you can check "PackageInstallerActivity.java" and "InstallAppProgress.java" in PackageInstaller source code. Package Manager Service running in system_service process and&nbsp; install daemon (installd) that runs as a native process both start at system boot time.</div><div class="p2"><br /></div><div class="p1" style="text-align: justify;"><br /></div><div class="p1" style="text-align: justify;"></div><div class="p1"><b><strong>2. Where APK files stores in Android ?</strong></b></div><div class="p2"><br /></div><div class="p1">1. Pre-Install (i.e. Camera, Calendar, Browser,etc.) APK stored in <b>/system/app/</b></div><div class="p1">2. User Install (ApiDemo, Any.do, etc.) APK stored in <b>/data/app/</b></div><div class="p1">3. Package Manager create data directory <b>/data/data/&lt;package name&gt;/</b>&nbsp; to store database, shared preference, native library and cache data</div><div class="p2"><br /></div><div class="p1">You might see apk file and *.odex file for same APK, ODEX file is totally different discussion and purpose.</div><div class="p1"><br /></div><div class="p1"></div><div class="p1"><b><strong>3. What is APK installation process in detail ?</strong></b></div><div class="p2"><br /></div><div class="p1">Following process execute in Package Manager Service.</div><div class="p2"><br /></div><div class="p1">- Waiting&nbsp;</div><div class="p1">- Add a package to the queue for the installation process&nbsp;</div><div class="p1">- Determine the appropriate location of the package installation&nbsp;</div><div class="p1">- Determine installation Install / Update new&nbsp;</div><div class="p1">- A copy of the apk file to a given directory&nbsp;</div><div class="p1">- Determine the UID of the app&nbsp;</div><div class="p1">- Request to installd daemon process&nbsp;</div><div class="p1">- Create the application directory and set permissions&nbsp;</div><div class="p1">- Extraction of dex code to the cache directory&nbsp;</div><div class="p1">- To reflect and packages.list / system / data / packages.xml the latest status&nbsp;</div><div class="p1">- Broadcast to the system along with the name of the effect of the installation is complete package&nbsp;</div><div class="p1">Intent.ACTION_PACKAGE_ADDED: If the new ( Intent.ACTION_PACKAGE_REPLACED): the case of an update<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-Z2m5BI4bY8A/UI620rmsneI/AAAAAAAADfo/1AGZGc21uNY/s1600/Package+Installer.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="300" src="http://4.bp.blogspot.com/-Z2m5BI4bY8A/UI620rmsneI/AAAAAAAADfo/1AGZGc21uNY/s400/Package+Installer.jpg" width="400" /></a></div><br /></div><div class="p1"><br /></div><div class="p1"><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: left;"></div><div class="p1"><b><strong>4. How Package Manager store data ?</strong></b></div><div class="p2"><br /></div><div class="p1">Package Manager store application information in three files, located in&nbsp;<b> /data/system. </b>Following sample is extracted from Android 4 ICS emulator image.</div><div class="p2"><br /></div><div class="p1"><b>1. packages.xml</b> :This file contain list of permissions and Packages/Applications.&nbsp;</div><pre class="brush: xml;"><packages><br /><last-platform-version external="15" internal="15"><br /><permission-trees><br /><permissions><br /><item name="android.permission.CHANGE_WIFI_MULTICAST_STATE" package="android" protection="1"><br /><item name="android.permission.CLEAR_APP_USER_DATA" package="android" protection="2"><br />.<br />.<br />.<br />. <br /></item></item></permissions><br /><br /><package codepath="/system/app/Contacts.apk" flags="1" ft="136567b3990" it="136567b3990" name="com.android.contacts" nativelibrarypath="/data/data/com.android.contacts/lib" shareduserid="10001" ut="136567b3990" version="15"><br /><sigs count="1"><br /><cert index="2"><br /></cert></sigs><br /></package><br />.<br />.<br />.<br />.<br /><package codepath="/data/app/com.project.t2i-2.apk" flags="0" ft="13a837c2068" it="13a83704ea3" name="com.project.t2i" nativelibrarypath="/data/data/com.project.t2i/lib" userid="10040" ut="13a837c2ecb" version="1"><br /><sigs count="1"><br /><cert index="3" key="308201e53082014ea0030201020204506825ae300d06092a86<br />4886f70d01010505003037310b30090603550406130255533110300e060355040a13074<br />16e64726f6964311630140603550403130d416e64726f6964204465627567301e170d31<br />32303933303130353735305a170d3432303932333130353735305a3037310b300906035<br />50406130255533110300e060355040a1307416e64726f6964311630140603550403130d<br />416e64726f696420446562756730819f300d06092a864886f70d010101050003818d003<br />08189028181009ce1c5fd64db794fd787887e8a2dccf6798ddd2fd6e1d8ab04cd8cdd9e<br />bf721fb3ed6be1d67c55ce729b1e1d32b200cbcfc91c798ef056bc9b2cbc66a396aed6b<br />a3629a18e4839353314252811412202500f11a11c3bf4eb41b2a8747c3c791c89391443<br />39036345b15b5e080469ac5f536fd9edffcd52dcbdf88cf43c580abd0203010001300d0<br />6092a864886f70d01010505000381810071fa013b4560f16640ed261262f32085a51fca<br />63fa6c5c46fde9a862b56b6d6f17dd49643086a39a06314426ba9a38b784601197246f8<br />d568e349a93bc6af315455de7a8923f40d4051a51e1658ee34aca41494ab94ce978ae38<br />609803dfb3004806634e6e78dd0be26fe75843958711935ffc85f9fcf81523ce23c86bc<br />c5c7a"><br /></cert></sigs><br /><perms><br /><item name="android.permission.WRITE_EXTERNAL_STORAGE"><br /></item></perms><br /></package><br />.<br />.<br />.<br />.<br />.<br /></permission-trees></last-platform-version></packages><br /></pre><div style="text-align: justify;">This xml file stores two things 1. permissions 2. package (application), permission are store under &lt;permissions&gt; tag. Each Permission has three attributes namely name, package and protection. Name attribute has permission name which we are using in AndroidManifest.xml, package attribute indicate permission belong to package, In majority cases "android" is values because &lt;permission&gt; tag contain default permissions and protection indicate level of security.</div><div class="p2"><br /></div><div class="p1">package tag contain 10 attributes and few sub tags.</div></div></div><!-- CSS goes in the document HEAD or added to your external stylesheet --><style type="text/css">table.gridtable {  font-size:11px;  color:#333333;  border-width: 1px;  border-color: #666666;  border-collapse: collapse; } table.gridtable th {  border-width: 1px;  padding: 8px;  border-style: solid;  border-color: #666666;  background-color: #dedede; } table.gridtable td {  border-width: 1px;  padding: 8px;  border-style: solid;  border-color: #666666;  background-color: #ffffff; } </style> <br /><table class="gridtable"><thead><tr><th>Sr</th><th>Attribute Name</th><th>Description</th></tr></thead><tbody><tr><td>1</td><td>name</td><td>package name</td></tr><tr><td>2</td><td>codePath</td><td>APK file installation location (/system/app/ or /data/app/)</td></tr><tr><td>3</td><td>nativeLibraryPath </td><td>native library (*.so file) default path is /data/data/&lt;package name&gt;/lib/</td></tr><tr><td>4</td><td>flag</td><td>Store ApplicationInfo Flags [http://developer.android.com/reference/android/content/pm/ApplicationInfo.html]</td></tr><tr><td>5</td><td>ft</td><td>timestamp in hex format</td></tr><tr><td>6</td><td>lt</td><td>timestamp in hex format of first time installation</td></tr><tr><td>7</td><td>ut</td><td>timestamp in hex format of last update </td></tr><tr><td>8</td><td>version</td><td>Version Code from AndroidManifest.xml file []http://developer.android.com/guide/topics/manifest/manifest-element.html#vcode]</td></tr><tr><td>9</td><td>sharedUserId</td><td>The name of Linux user ID that will be shared with other applications, It is same parameter which we define in AndroidManifest.xml [http://developer.android.com/guide/topics/manifest/manifest-element.html#uid]</td></tr><tr><td>10</td><td>userId</td><td>The name of a Linux user ID </td></tr></tbody></table><br /><b>Sub Tags</b><br /><div class="p2">1. <b>sigs</b><span class="Apple-tab-span"> </span>signature information, count attribute represent number of cert tag.</div><div class="p1">2. <b>cert </b><span class="Apple-tab-span">&nbsp;</span>contain certification key , index attribute represent global index of certificate, I observer that it increment when new certificate install with application.</div><div class="p1">3. <b>perms&nbsp;</b>contain permission which developer has set in AndroidManifest.xml</div><div class="p1"><br /></div><div class="p1"></div><div class="p1"><div style="text-align: justify;"><b>2. packages.list :</b> It is simple text file contain package name, user id ,flag and data directory, I can't find any perfect description but I assume it that packages.list file may provide faster lookup of installed package because it file keep important information only.</div></div><div class="p1"><br /></div><pre class="brush: xml;">com.android.launcher 10013 0 /data/data/com.android.launcher<br />com.android.quicksearchbox 10033 0 /data/data/com.android.quicksearchbox<br />com.android.contacts 10001 0 /data/data/com.android.contacts<br />com.android.inputmethod.latin 10006 0 /data/data/com.android.inputmethod.latin<br /></pre><br /><div style="text-align: justify;"><b>3. packages-stoped.xml :</b> This file contain package list which has stopped state, Stope stated applications can not receive any broadcast. Refer this link for more information about stopped state application <a href="http://yuki312.blogspot.in/2012/03/androidbroadcaststop.html">http://yuki312.blogspot.in/2012/03/androidbroadcaststop.html</a>&nbsp;</div><pre class="brush: xml;"><stopped-packages><br /><pkg name="com.android.widgetpreview" nl="1"></pkg><br /><pkg name="com.example.android.livecubes" nl="1"></pkg><br /><pkg name="com.android.gesture.builder" nl="1"></pkg><br /><pkg name="com.example.android.softkeyboard" nl="1"></pkg><br /></stopped-packages><br /></pre><br /><b>4. Where I can find the source code of Package Manager and Package Installer ?</b><br /><br /><div class="p1"><b>Package Manager</b></div><div class="p1"><a href="https://android.googlesource.com/platform/frameworks/base/+/483f3b06ea84440a082e21b68ec2c2e54046f5a6/services/java/com/android/server/pm/Settings.java" target="_blank">frameworks/base/services/java/com/android/server/pm/Settings.java</a></div><div class="p1"><a href="https://android.googlesource.com/platform/frameworks/base/+/483f3b06ea84440a082e21b68ec2c2e54046f5a6/services/java/com/android/server/pm/PackageManagerService.java" target="_blank">frameworks/base/services/java/com/android/server/pm/PackageManagerService.java</a></div><div class="p1"><a href="https://android.googlesource.com/platform/frameworks/base/+/483f3b06ea84440a082e21b68ec2c2e54046f5a6/core/java/android/content/pm/IPackageManager.aidl" target="_blank">frameworks/base/services/java/com/android/server/pm/IPackageManager.aidl</a></div><div class="p1"><a href="https://android.googlesource.com/platform/frameworks/base/+/483f3b06ea84440a082e21b68ec2c2e54046f5a6/services/java/com/android/server/pm/PackageSignatures.java" target="_blank">frameworks/base/services/java/com/android/server/pm/PackageSignatures.java</a></div><div class="p1"><a href="https://android.googlesource.com/platform/frameworks/base/+/483f3b06ea84440a082e21b68ec2c2e54046f5a6/services/java/com/android/server/pm/PreferredActivity.java" target="_blank">frameworks/base/services/java/com/android/server/pm/PreferredActivity.java</a></div><div class="p1"><a href="https://android.googlesource.com/platform/frameworks/base/+/483f3b06ea84440a082e21b68ec2c2e54046f5a6/services/java/com/android/server/PreferredComponent.java" target="_blank">frameworks/services/java/com/android/server/PreferredComponent.java</a></div><div class="p1"><a href="https://android.googlesource.com/platform/frameworks/base/+/483f3b06ea84440a082e21b68ec2c2e54046f5a6/core/java/android/content/IntentFilter.java" target="_blank">frameworks/core/java/android/content/IntentFilter.java</a></div><div class="p1"><a href="https://android.googlesource.com/platform/frameworks/base/+/483f3b06ea84440a082e21b68ec2c2e54046f5a6/core/java/android/content/pm/PackageParser.java" target="_blank">frameworks/base/core/java/android/content/pm/PackageParser.java</a></div><div class="p1"><a href="https://android.googlesource.com/platform/frameworks/base/+/483f3b06ea84440a082e21b68ec2c2e54046f5a6/services/java/com/android/server/pm/Installer.java" target="_blank">frameworks/base/services/java/com/android/server/pm/Installer.java</a></div><div class="p1"><a href="https://android.googlesource.com/platform/frameworks/base/+/483f3b06ea84440a082e21b68ec2c2e54046f5a6/core/java/com/android/internal/app/IMediaContainerService.aidl" target="_blank">frameworks/base/core/java/com/android/internal/app/IMediaContainerService.aidl</a></div><div class="p1"><a href="https://android.googlesource.com/platform/frameworks/base/+/483f3b06ea84440a082e21b68ec2c2e54046f5a6/packages/DefaultContainerService/src/com/android/defcontainer/DefaultContainerService.java" target="_blank">frameworks/base/packages/DefaultContainerService/src/com/android/defcontainer/DefaultContainerService.java</a></div><div class="p2"><br /></div><div class="p1"><b>Package Installer</b></div><div class="p1"><a href="https://android.googlesource.com/platform/packages/apps/PackageInstaller/+/47fe118e0178e9d72c98073ff588ee5cf353258e/src/com/android/packageinstaller/PackageInstallerActivity.java" target="_blank">packages/apps/PackageInstaller/src/com/android/packageinstaller/PackageInstallerActivity.java</a></div><div class="p1"><a href="https://android.googlesource.com/platform/packages/apps/PackageInstaller/+/47fe118e0178e9d72c98073ff588ee5cf353258e/src/com/android/packageinstaller/PackageUtil.java" target="_blank">packages/apps/PackageInstaller/src/com/android/packageinstaller/PackageUtil.java</a></div><a href="https://android.googlesource.com/platform/packages/apps/PackageInstaller/+/47fe118e0178e9d72c98073ff588ee5cf353258e/src/com/android/packageinstaller/InstallAppProgress.java" target="_blank">packages/apps/PackageInstaller/src/com/android/packageinstaller/InstallAppProgress.java&nbsp;</a></div>